// ====================================================================
//                      3D PORTFOLIO PORTAL - MAIN MODULE
// ====================================================================
// ZWECK DIESER DATEI:
// Diese Datei ist der "Dirigent eines Orchesters" - sie koordiniert alle
// anderen Module und bringt sie in der richtigen Reihenfolge zusammen,
// um das komplette 3D-Portal zu erstellen.
//
// WAS PASSIERT HIER:
// 1. Alle Module werden importiert (wie Instrumentengruppen im Orchester)
// 2. Initialisierungs-Sequenz startet alle Systeme in der richtigen Reihenfolge
// 3. Render-Schleife l√§uft kontinuierlich und aktualisiert alle Animationen
// 4. Error-Handling falls etwas schiefgeht
//
// MODULE-ORCHESTRIERUNG:
// ‚Ä¢ scene.js ‚Üí B√ºhne aufbauen (Renderer, Kamera, Szene)
// ‚Ä¢ portal.js ‚Üí Hauptdarsteller erstellen (das magische Portal)
// ‚Ä¢ decorations.js ‚Üí B√ºhnenbild hinzuf√ºgen (Ringe, S√§ulen, Partikel)
// ‚Ä¢ interactions.js ‚Üí Publikum einbeziehen (Klick-Events, Men√º)
// ‚Ä¢ loading.js ‚Üí Vorhang-Management (Loading-Screen)
// ‚Ä¢ camera.js ‚Üí Kameramann-Arbeit (Bewegungen, √úberg√§nge)
//
// WARUM DIESE STRUKTUR:
// ‚Ä¢ Trennung der Verantwortlichkeiten (jedes Module hat einen klaren Zweck)
// ‚Ä¢ Wartbarkeit (Bugs sind in spezifischen Modulen lokalisiert)
// ‚Ä¢ Skalierbarkeit (neue Features k√∂nnen als neue Module hinzugef√ºgt werden)
// ‚Ä¢ Teamwork (verschiedene Entwickler k√∂nnen an verschiedenen Modulen arbeiten)
//
// ANALOGIE:
// Diese Datei ist wie der Regisseur eines Films:
// ‚Ä¢ Koordiniert alle Abteilungen (Kamera, Beleuchtung, Spezialeffekte)
// ‚Ä¢ Stellt sicher dass alles zur richtigen Zeit passiert
// ‚Ä¢ Beh√§lt den √úberblick √ºber das gro√üe Ganze
// ‚Ä¢ Sorgt f√ºr einen smooth Ablauf vom Start bis zum Ende
// ====================================================================

// ====================================================================
//                          MODULE IMPORTS
// ====================================================================

// Szenen-Grundlagen
import { 
  initializeScene, 
  setupLighting, 
  setupPostProcessing, 
  setupResizeHandler 
} from './js/modules/scene.js';

// Portal-System  
import { 
  createPortalMaterial, 
  createPortalGeometry, 
  updatePortalAnimation 
} from './js/modules/portal.js';

// Dekorationen
import { 
  createTorusRings, 
  createBackgroundColumns, 
  createParticleSystem, 
  updateDecorations 
} from './js/modules/decorations.js';

// Hyperspace-Tunnel (Star Wars Style!)
import {
  createTunnel,
  activateTunnel,
  updateTunnel,
  changeTunnelColors
} from './js/modules/tunnel.js';

// Interaktionen
import { 
  initializePortalInteraction
} from './js/modules/interactions.js';

// Loading-System
import { 
  setLoadingProgress, 
  hideLoading, 
  checkAutoHide, 
  enableAutoHide 
} from './js/modules/loading.js';

// Kamera-System
import { 
  updateCameraMovement 
} from './js/modules/camera.js';

// Erst mal nur Basis-Module laden (die anderen sp√§ter)
// Audio-System wird dynamisch geladen
// Screen-Shake wird dynamisch geladen  
// Particle-System wird dynamisch geladen
// Chromatic Aberration wird dynamisch geladen

// Hover-Effekte
import {
  updateHoverEffects
} from './js/modules/interactions.js';

// ====================================================================
//                        GLOBALE VARIABLEN
// ====================================================================

let scene, camera, renderer, composer, bloomPass;
let portalMesh, portalUniforms;
let torusGroup, particles;
let tunnelGroup; // Star Wars Hyperspace-Tunnel
let startTime;

// ====================================================================
//                      INITIALISIERUNG
// ====================================================================

/**
 * Hauptinitialisierung - erstellt die komplette 3D-Szene
 */
async function initialize() {
  console.log('üöÄ Starte 3D-Portal Initialisierung...');
  
  try {
    // ================================================================
    // SCHRITT 1: SZENEN-GRUNDLAGEN
    // ================================================================
    setLoadingProgress(5, 'Erstelle Renderer');
    const sceneData = initializeScene();
    scene = sceneData.scene;
    camera = sceneData.camera;
    renderer = sceneData.renderer;
    
    setLoadingProgress(18, 'Renderer bereit');
    
    // ================================================================
    // SCHRITT 2: BELEUCHTUNG
    // ================================================================
    setupLighting(scene);
    
    // ================================================================
    // SCHRITT 3: POST-PROCESSING (BLOOM)
    // ================================================================
    setLoadingProgress(36, 'Post-Processing geladen');
    const postProcessing = setupPostProcessing(renderer, scene, camera);
    composer = postProcessing.composer;
    bloomPass = postProcessing.bloomPass;
    
    // ================================================================
    // SCHRITT 4: PORTAL ERSTELLEN
    // ================================================================
    setLoadingProgress(64, 'Shader kompiliert');
    const portalData = createPortalMaterial();
    portalUniforms = portalData.portalUniforms;
    
    setLoadingProgress(78, 'Portal erstellt');
    portalMesh = createPortalGeometry(scene, portalData.portalMaterial);
    
    // ================================================================
    // SCHRITT 5: DEKORATIONEN HINZUF√úGEN
    // ================================================================
    setLoadingProgress(88, 'Partikel bereit');
    torusGroup = createTorusRings(scene);
    createBackgroundColumns(scene);
    particles = createParticleSystem(scene);
    
    // ================================================================
    // SCHRITT 6: HYPERSPACE-TUNNEL ERSTELLEN
    // ================================================================
    setLoadingProgress(88, 'Hyperspace-Tunnel l√§dt...');
    tunnelGroup = createTunnel(scene);
    console.log('üå™Ô∏è Star Wars Tunnel bereit!');
    
    // ================================================================
    // SCHRITT 7: ERWEITERTE EFFEKTE (DYNAMISCH LADEN)
    // ================================================================
    setLoadingProgress(90, 'Erweiterte Effekte werden geladen...');
    
    // Lade Effekt-Module dynamisch
    try {
      const audioModule = await import('./js/modules/audio.js');
      audioModule.initializeAudio();
      console.log('üîä Audio-System geladen!');
      
      // Audio-Aktivierung bei erstem Klick
      window.audioModule = audioModule;
    } catch (error) {
      console.log('‚ö†Ô∏è Audio-System √ºbersprungen:', error.message);
    }
    
    try {
      const shakeModule = await import('./js/modules/shake.js');
      shakeModule.initializeShakeSystem(camera, renderer);
      window.shakeModule = shakeModule;
      console.log('üì≥ Shake-System geladen!');
    } catch (error) {
      console.log('‚ö†Ô∏è Shake-System √ºbersprungen:', error.message);
    }
    
    try {
      const particleModule = await import('./js/modules/particles.js');
      particleModule.initializeParticleExplosions(scene);
      // KEINE Portal-Energy-Particles! Die st√∂ren das Portal!
      window.particleModule = particleModule;
      console.log('üí• Partikel-System geladen (ohne Portal-Energy)!');
    } catch (error) {
      console.log('‚ö†Ô∏è Partikel-System √ºbersprungen:', error.message);
    }
    
    console.log('‚ú® Basis-Effekte erfolgreich geladen!');
    
    // ================================================================
    // SCHRITT 11: INTERAKTIONEN EINRICHTEN
    // ================================================================
    initializePortalInteraction(portalMesh, camera, portalUniforms, bloomPass, scene); // Szene √ºbergeben!
    // Men√º-Events entfernt - nur Portal-Interaktion!
    
    // ================================================================
    // SCHRITT 12: EVENT-LISTENER
    // ================================================================
    setupResizeHandler(camera, renderer, composer, portalUniforms);
    
    // ================================================================
    // SCHRITT 13: FINALE KONFIGURATION
    // ================================================================
    configureFinalSettings();
    
    setLoadingProgress(100, 'ALLES BEREIT ‚Äî ULTIMATIVE SCI-FI-EXPERIENCE!');
    
    // ================================================================
    // SCHRITT 9: RENDER-SCHLEIFE STARTEN
    // ================================================================
    startTime = performance.now();
    enableAutoHide(); // Auto-Hide nach ersten Frames
    animate();
    
    console.log('‚úÖ 3D-Portal erfolgreich initialisiert!');
    
  } catch (error) {
    console.error('‚ùå Fehler bei Initialisierung:', error);
    setLoadingError('Initialisierung fehlgeschlagen');
  }
}

// ====================================================================
//                      FINALE KONFIGURATION
// ====================================================================

/**
 * Setzt finale Einstellungen f√ºr optimale Darstellung
 */
function configureFinalSettings() {
  console.log('‚öôÔ∏è Konfiguriere finale Einstellungen...');
  
  // Portal-Einstellungen (ORIGINAL GLOW ZUR√úCK!)
  portalUniforms.glow.value = 0.3;     // Original Glow
  portalUniforms.speed.value = 1.6;    // Mittlere Geschwindigkeit
  bloomPass.strength = 2.9;            // ORIGINAL STARKER BLOOM ZUR√úCK!
  
  // UI-Kontrollen synchronisieren (auch wenn versteckt)
  const glowCtrl = document.getElementById('ctrl-glow');
  const speedCtrl = document.getElementById('ctrl-speed');
  const bloomCtrl = document.getElementById('ctrl-bloom');
  
  if (glowCtrl) glowCtrl.value = portalUniforms.glow.value.toString();
  if (speedCtrl) speedCtrl.value = portalUniforms.speed.value.toString();
  if (bloomCtrl) bloomCtrl.value = bloomPass.strength.toString();
  
  console.log('üéØ Finale Konfiguration abgeschlossen');
}

// ====================================================================
//                        RENDER-SCHLEIFE
// ====================================================================

/**
 * Hauptanimations-Schleife - l√§uft 60fps
 */
function animate() {
  // Aktuelle Zeit berechnen
  const currentTime = (performance.now() - startTime) * 0.001; // In Sekunden
  
  // ================================================================
  // PORTAL ANIMATIONEN
  // ================================================================
  updatePortalAnimation(portalUniforms, currentTime);
  
  // ================================================================
  // DEKORATIONS ANIMATIONEN  
  // ================================================================
  updateDecorations(torusGroup, particles, currentTime, portalUniforms.speed.value);
  
  // ================================================================
  // KAMERA BEWEGUNGEN
  // ================================================================
  updateCameraMovement(camera, currentTime);
  
  // ================================================================
  // HYPERSPACE-TUNNEL ANIMATION
  // ================================================================
  updateTunnel(0.016); // ~60fps Delta-Time
  
  // ================================================================
  // ERWEITERTE EFFEKT-SYSTEME UPDATEN (FALLS GELADEN)
  // ================================================================
  
  try {
    // Screen-Shake updaten (falls verf√ºgbar)
    if (window.shakeModule) {
      window.shakeModule.updateShake(0.016);
    }
    
    // Particle-Explosionen updaten (falls verf√ºgbar)  
    if (window.particleModule) {
      window.particleModule.updateParticleExplosions(0.016);
    }
    
    // Hover-Effekte updaten
    updateHoverEffects();
    
  } catch (error) {
    // Ignoriere Effekt-Fehler, damit Basis-Portal weiterl√§uft
  }
  
  // ================================================================
  // RENDERN
  // ================================================================
  composer.render();
  
  // ================================================================
  // LOADING AUTO-HIDE CHECK
  // ================================================================
  checkAutoHide();
  
  // N√§chsten Frame anfordern
  requestAnimationFrame(animate);
}

// ====================================================================
//                    AUDIO-AKTIVIERUNG BEI ERSTEM KLICK
// ====================================================================

// Audio bei erstem User-Click aktivieren (Browser-Requirement)
document.addEventListener('click', () => {
  try {
    if (window.audioModule) {
      window.audioModule.enableAudio();
      console.log('üîä Audio durch User-Klick aktiviert!');
    }
  } catch (e) {
    console.log('‚ö†Ô∏è Audio-Aktivierung √ºbersprungen:', e.message);
  }
}, { once: true }); // Nur beim ersten Klick

// ====================================================================
//                          STARTUP
// ====================================================================

// Entwickler-Info in Konsole
console.log(`
üöÄ ULTIMATIVE SCI-FI PORTAL EXPERIENCE üöÄ
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ú® Interaktives WebGL-Portal mit ALLEN Effekten!
üîä Hyperspace-Audio & Sound-Effects
üì≥ Screen-Shake & Camera-Vibration  
üí• Particle-Explosionen & Energy-Bursts
üåà Chromatic Aberration Post-Processing
‚ú® Hover-Effekte & Portal-Pulsing
üå™Ô∏è Star Wars-Style Hyperspace-Tunnel
‚ö° Flash-Effekte & Micro-Transitions

üéØ Klicke ins Portal f√ºr EPISCHEN Hyperspace-Flug!
üîß Powered by Three.js + Web Audio API

üí° Tipp: Verwende lokalen HTTP-Server f√ºr Audio!
`);

// Initialisierung starten
initialize();